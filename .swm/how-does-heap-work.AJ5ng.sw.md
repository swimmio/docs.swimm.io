---
id: AJ5ng
name: How Does Heap Work?
file_version: 1.0.2
app_version: 0.6.3-1
file_blobs:
  docusaurus.config.js: c13ae5a0e2b808d763ea63d90562cce49866fbbe
  src/theme/Footer.js: 29f5e1aba5ef218dc8e5d201e136ea4d8b731232
---

Heap Is Currently Kind Of Messy.
--------------------------------

Originally, we wanted to load heap through Google Tag Manager as described in [SEO Plugin Configuration](seo-plugin-configuration.faNzX.sw.md), however, we could not (for reasons that are yet to be understood) get heap to actually fire on the page, even when the code was obviously there.

To get around that, we're loading it **synchronously** in the footer through an ad-hoc component we call by wrapping the theme/Footer component that actually runs the heap code in the browser.

How Do I Turn Heap On Or Off?
-----------------------------

If that's all you need to do, see below, and you can skip the rest of this document.

<br/>

In the main site config, set `enableHeapAnalytics`[<sup id="Z2jBSsd">â†“</sup>](#f-Z2jBSsd) within `customFields`[<sup id="1b4Gb8">â†“</sup>](#f-1b4Gb8) to the desired value. `true` means Heap will load, `false` turns it off.
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ğŸ“„ docusaurus.config.js
```javascript
â¬œ 14       organizationName: 'swimmio', // Usually your GitHub org/user name.
â¬œ 15       projectName: 'docs.swimm.io', // Usually your repo name.
â¬œ 16       titleDelimiter: 'ğŸŠ',
ğŸŸ© 17       customFields: {
ğŸŸ© 18         enableHeapAnalytics: true,
ğŸŸ© 19       },
â¬œ 20       presets: [
â¬œ 21         [
â¬œ 22           '@docusaurus/preset-classic',
```

<br/>

How is Heap actually sent to the browser and run?
-------------------------------------------------

To avoid swizzling theme components during the Docusaurus2 beta, we define a new footer component that just wraps the standard footer component. This happens in `ğŸ“„ src/theme/Footer.js`, which Docusaurus knows to load in lieu of the standard footer component:

<br/>

We can't import Footer from Footer because to understand recursion is to understand recursion, so we just grab a reference copy of the original `@theme-original/Footer` as `OrginalFooter`.
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ğŸ“„ src/theme/Footer.js
```javascript
ğŸŸ© 1      import OriginalFooter from '@theme-original/Footer';
â¬œ 2      import React from 'react';
```

<br/>

Then, we talk to `useDocusaurusContext`[<sup id="Z48WAN">â†“</sup>](#f-Z48WAN) to grab the global config and see if we're supposed to run, and then do a quick check to make sure we're not running locally. Heap events should only fire in production, not in development or staging.
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ğŸ“„ src/theme/Footer.js
```javascript
â¬œ 11      * This renders nothing, it just executes code in the browswer.
â¬œ 12      */
â¬œ 13     export function HeapAnalytics() {
ğŸŸ© 14         /* Don't run if disabled. */
ğŸŸ© 15         const {siteConfig, siteMetadata} = useDocusaurusContext();
ğŸŸ© 16         if (siteConfig.customFields.enableHeapAnalytics == false)
ğŸŸ© 17             return null;
ğŸŸ© 18     
ğŸŸ© 19         /* Never run in staging / locally. */
ğŸŸ© 20         if (location.hostname === "localhost" || location.hostname === "127.0.0.1")
ğŸŸ© 21             return null;
â¬œ 22     
â¬œ 23         window.heap = window.heap || [], heap.load = function(e, t) {
â¬œ 24         window.heap.appid = e, window.heap.config = t = t || {};
```

<br/>

Then, we present the original theme footer through the reference we made, and if (and only if) we're running in a browser do we actually run the code via `<HeapAnalytics>`.
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ğŸ“„ src/theme/Footer.js
```javascript
â¬œ 45         return null;
â¬œ 46     }
â¬œ 47     
ğŸŸ© 48     export default function Footer(props) {
ğŸŸ© 49         const isBrowser = useIsBrowser();
ğŸŸ© 50         return (
ğŸŸ© 51             <>
ğŸŸ© 52             <OriginalFooter {...props} />
ğŸŸ© 53             {isBrowser && <HeapAnalytics />}
ğŸŸ© 54             </>
ğŸŸ© 55         );
ğŸŸ© 56     }
```

<br/>

Why is this icky, and what will change?
---------------------------------------

We should just load Heap through `<script>` tags in the header like anything else, and also be able to control events and stuff from the configuration. It's a very simple plugin to write in order to accomplish this, but we'll do that during a cool-down cycle.

<br/>

<!-- THIS IS AN AUTOGENERATED SECTION. DO NOT EDIT THIS SECTION DIRECTLY -->
### Swimm Note

<span id="f-1b4Gb8">customFields</span>[^](#1b4Gb8) - "docusaurus.config.js" L17
```javascript
  customFields: {
```

<span id="f-Z2jBSsd">enableHeapAnalytics</span>[^](#Z2jBSsd) - "docusaurus.config.js" L18
```javascript
    enableHeapAnalytics: true,
```

<span id="f-Z48WAN">useDocusaurusContext</span>[^](#Z48WAN) - "src/theme/Footer.js" L15
```javascript
    const {siteConfig, siteMetadata} = useDocusaurusContext();
```

<br/>

This file was generated by Swimm. [Click here to view it in the app](https://app.swimm.io/#/repos/Z2l0aHViJTNBJTNBZG9jcy5zd2ltbS5pbyUzQSUzQXN3aW1taW8=/docs/AJ5ng).